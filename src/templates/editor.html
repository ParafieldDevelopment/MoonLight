<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MoonLight - Editor</title>
    <link rel="stylesheet" href="<%= urlFor('assets/css/editor.css') %>">
    <link rel="stylesheet" href="<%= urlFor('assets/css/topbar.css') %>">
    <style>
        /* Dropdown Menu Styles */
        .menu-item-container {
            position: relative;
            -webkit-app-region: no-drag;
        }

        .topbar-buttons p {
            padding: 2px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            margin: 0;
            user-select: none;
        }

        .topbar-buttons p:hover, .topbar-buttons p.active {
            background-color: #3c3c3c;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #2b2d30;
            border: 1px solid #43454a;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            min-width: 180px;
            z-index: 1000;
            display: none;
            padding: 4px 0;
            margin-top: 4px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #dfe1e5;
            cursor: pointer;
            font-size: 13px;
        }

        .dropdown-item:hover {
            background-color: #4e5057;
        }

        .dropdown-divider {
            height: 1px;
            background-color: #43454a;
            margin: 4px 0;
        }

        .shortcut {
            color: #868a91;
            font-size: 11px;
            margin-left: 20px;
        }
    </style>
</head>
<body>

<!-- Topbar -->
<nav class="topnav">
    <div class="topbar">
        <img src="app://assets/iconcircle2.png" class="icon" alt="App Icon">
        <div class="topbar-buttons">
            <div class="menu-item-container">
                <p id="file-menu-btn"><u>F</u>ile</p>
                <div id="file-menu" class="dropdown-menu">
                    <div class="dropdown-item" data-action="new-file">New File... <span class="shortcut">Ctrl+N</span></div>
                    <div class="dropdown-item" data-action="open-file">Open... <span class="shortcut">Ctrl+O</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="save-file">Save <span class="shortcut">Ctrl+S</span></div>
                    <div class="dropdown-item" data-action="save-all">Save All <span class="shortcut">Ctrl+Shift+S</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="close-project">Close Project</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="exit">Exit</div>
                </div>
            </div>
            <div class="menu-item-container">
                <p id="edit-menu-btn"><u>E</u>dit</p>
                <div id="edit-menu" class="dropdown-menu">
                    <div class="dropdown-item" data-action="undo">Undo <span class="shortcut">Ctrl+Z</span></div>
                    <div class="dropdown-item" data-action="redo">Redo <span class="shortcut">Ctrl+Y</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="cut">Cut <span class="shortcut">Ctrl+X</span></div>
                    <div class="dropdown-item" data-action="copy">Copy <span class="shortcut">Ctrl+C</span></div>
                    <div class="dropdown-item" data-action="paste">Paste <span class="shortcut">Ctrl+V</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="find">Find... <span class="shortcut">Ctrl+F</span></div>
                    <div class="dropdown-item" data-action="replace">Replace... <span class="shortcut">Ctrl+R</span></div>
                </div>
            </div>
            <div class="menu-item-container">
                <p id="view-menu-btn"><u>V</u>iew</p>
                <div id="view-menu" class="dropdown-menu">
                    <div class="dropdown-item" data-action="toggle-sidebar">Appearance <span class="shortcut">></span></div>
                    <div class="dropdown-item" data-action="zoom-in">Zoom In <span class="shortcut">Ctrl++</span></div>
                    <div class="dropdown-item" data-action="zoom-out">Zoom Out <span class="shortcut">Ctrl+-</span></div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="fullscreen">Full Screen <span class="shortcut">F11</span></div>
                </div>
            </div>
            <div class="menu-item-container">
                <p id="help-menu-btn"><u>H</u>elp</p>
                <div id="help-menu" class="dropdown-menu">
                    <div class="dropdown-item" data-action="about">About MoonLight</div>
                    <div class="dropdown-item" data-action="check-updates">Check for Updates...</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="documentation">Documentation</div>
                    <div class="dropdown-item" data-action="report-issue">Report Issue</div>
                </div>
            </div>
        </div>
        <p class="project-name">MyProject</p>
    </div>
    <div class="topbar-right">
        <div class="toolbar-group">
            <button title="Run"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" /></svg></button>
            <button title="Settings"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.332.183-.582.495-.645.87l-.213 1.28c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" /></svg></button>
        </div>
        <div class="window-controls">
            <button id="min-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14"/></svg></button>
            <button id="max-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M4 4h16v16H4z" fill="none" stroke="currentColor" stroke-width="2"/></svg></button>
            <button id="close-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="22" height="22"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg></button>
        </div>
    </div>
</nav>

<!-- Main IDE Body -->
<div class="ide-body">
    <div class="tool-bar left">
        <div class="tool-group-top">
            <button class="tool-window-button active" data-target="#project-panel" data-position="left">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>
            </button>
        </div>
        <div class="tool-group-bottom">
            <button class="tool-window-button" data-target="#problems-panel" data-position="bottom">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
            </button>
            <button class="tool-window-button" data-target="#output-panel" data-position="bottom">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>
            </button>
        </div>
    </div>

    <div class="main-content-wrapper">
        <div class="editor-main-area">
            <div id="project-panel" class="side-panel">
                <div class="panel-header"><h3>Project</h3></div>
                <ul class="file-list">
                    <!-- File structure here -->
                </ul>
            </div>
            <div class="resizer" id="explorer-resizer"></div>
            <div class="editor-container">
                <div class="tabs">
                    <div class="tab active"><span>ServerScript</span><button class="close-tab">Ã—</button></div>
                </div>
                <div class="editor-area">
                    <div class="code-editor"><textarea>print("Hello, world!")</textarea></div>
                </div>
            </div>
        </div>
        <div class="resizer-h" id="bottom-resizer"></div>
        <div id="problems-panel" class="bottom-panel is-hidden">
            <div class="panel-header"><h3>Problems</h3></div>
            <p>No problems have been detected.</p>
        </div>
        <div id="output-panel" class="bottom-panel is-hidden">
            <div class="panel-header"><h3>Output</h3></div>
            <p>Output will appear here.</p>
        </div>
    </div>

    <div class="tool-bar right">
        <!-- Right-side buttons go here -->
    </div>
</div>

<!-- Status Bar -->
<div class="statusbar">
    <div class="breadcrumb"><span>MyProject > Workspace > ServerScript</span></div>
    <div class="right"><span>Ln 1, Col 1</span><span>Spaces: 4</span><span>UTF-8</span></div>
</div>

<script>
    document.getElementById('min-btn').addEventListener('click', () => window.moonlight.minimize());
    document.getElementById('max-btn').addEventListener('click', () => window.moonlight.maximize());
    document.getElementById('close-btn').addEventListener('click', () => window.moonlight.close());

    // Menu dropdown logic
    const menuButtons = document.querySelectorAll('.topbar-buttons p');
    const dropdowns = document.querySelectorAll('.dropdown-menu');

    menuButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = btn.nextElementSibling;
            const isShowing = menu.classList.contains('show');

            // Hide all first
            dropdowns.forEach(d => d.classList.remove('show'));
            menuButtons.forEach(b => b.classList.remove('active'));

            if (!isShowing) {
                menu.classList.add('show');
                btn.classList.add('active');
            }
        });

        btn.addEventListener('mouseenter', () => {
            // If another menu is already open, switch to this one
            const anyOpen = Array.from(dropdowns).some(d => d.classList.contains('show'));
            if (anyOpen) {
                dropdowns.forEach(d => d.classList.remove('show'));
                menuButtons.forEach(b => b.classList.remove('active'));
                btn.nextElementSibling.classList.add('show');
                btn.classList.add('active');
            }
        });
    });

    // Close menus when clicking outside
    document.addEventListener('click', () => {
        dropdowns.forEach(d => d.classList.remove('show'));
        menuButtons.forEach(b => b.classList.remove('active'));
    });

    // Handle menu item actions
    document.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = item.dataset.action;
            console.log("Menu Action:", action);
            
            if (window.moonlight && window.moonlight.menuAction) {
                window.moonlight.menuAction(action);
            }
            
            dropdowns.forEach(d => d.classList.remove('show'));
            menuButtons.forEach(b => b.classList.remove('active'));
        });
    });

    // Tool window toggling logic
    const toolButtons = document.querySelectorAll('.tool-window-button');
    const sidePanel = document.getElementById('project-panel');
    const resizer = document.getElementById('explorer-resizer');
    const bottomResizer = document.getElementById('bottom-resizer');

    async function updateBottomResizerVisibility() {
        const anyBottomVisible = !document.getElementById('problems-panel').classList.contains('is-hidden') || 
                                 !document.getElementById('output-panel').classList.contains('is-hidden');
        bottomResizer.style.display = anyBottomVisible ? 'block' : 'none';
    }

    async function initExplorerState() {
        if (!window.moonlight || !window.moonlight.getSetting) return;
        
        const isCollapsed = await window.moonlight.getSetting('explorer-collapsed', false);
        const explorerWidth = await window.moonlight.getSetting('explorer-width', 250);
        const bottomHeight = await window.moonlight.getSetting('bottom-height', 200);
        const explorerBtn = document.querySelector('.tool-window-button[data-target="#project-panel"]');
        
        if (sidePanel) {
            sidePanel.style.width = explorerWidth + 'px';
        }

        document.querySelectorAll('.bottom-panel').forEach(p => {
            p.style.height = bottomHeight + 'px';
        });

        if (isCollapsed) {
            sidePanel.classList.add('collapsed');
            resizer.style.display = 'none';
            if (explorerBtn) explorerBtn.classList.remove('active');
        } else {
            sidePanel.classList.remove('collapsed');
            resizer.style.display = 'block';
            if (explorerBtn) explorerBtn.classList.add('active');
        }
    }

    // Resizing logic
    let isResizing = false;
    let isResizingBottom = false;
    let startY, startHeight;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        resizer.classList.add('resizing');
    });

    bottomResizer.addEventListener('mousedown', (e) => {
        isResizingBottom = true;
        startY = e.clientY;
        const activePanel = document.querySelector('.bottom-panel:not(.is-hidden)');
        startHeight = activePanel ? activePanel.offsetHeight : 200;
        document.body.style.cursor = 'row-resize';
        bottomResizer.classList.add('resizing');
    });

    document.addEventListener('mousemove', (e) => {
        if (isResizing) {
            let newWidth = e.clientX - sidePanel.getBoundingClientRect().left;
            
            // Boundaries (matched with CSS min/max)
            if (newWidth < 150) newWidth = 150;
            if (newWidth > 600) newWidth = 600;
            
            sidePanel.style.width = newWidth + 'px';
        }

        if (isResizingBottom) {
            let deltaY = startY - e.clientY;
            let newHeight = startHeight + deltaY;

            // Boundaries
            if (newHeight < 100) newHeight = 100;
            if (newHeight > 600) newHeight = 600;

            document.querySelectorAll('.bottom-panel').forEach(p => {
                p.style.height = newHeight + 'px';
            });
        }
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = 'default';
            resizer.classList.remove('resizing');
            
            if (window.moonlight && window.moonlight.saveSetting) {
                window.moonlight.saveSetting('explorer-width', parseInt(sidePanel.style.width));
            }
        }

        if (isResizingBottom) {
            isResizingBottom = false;
            document.body.style.cursor = 'default';
            bottomResizer.classList.remove('resizing');

            const currentHeight = parseInt(document.querySelector('.bottom-panel').style.height);
            if (window.moonlight && window.moonlight.saveSetting) {
                window.moonlight.saveSetting('bottom-height', currentHeight);
            }
        }
    });

    toolButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-target');
            const target = document.querySelector(targetId);
            if (!target) return;
            
            if (targetId === '#project-panel') {
                const isNowCollapsed = !target.classList.contains('collapsed');
                if (isNowCollapsed) {
                    target.classList.add('collapsed');
                    resizer.style.display = 'none';
                    btn.classList.remove('active');
                } else {
                    target.classList.remove('collapsed');
                    resizer.style.display = 'block';
                    btn.classList.add('active');
                }
                if (window.moonlight && window.moonlight.saveSetting) {
                    window.moonlight.saveSetting('explorer-collapsed', isNowCollapsed);
                }
            } else {
                // Exclusive toggling for panels in the same position (mainly for bottom panels)
                const position = btn.getAttribute('data-position');
                if (position) {
                    document.querySelectorAll(`.tool-window-button[data-position="${position}"]`).forEach(b => {
                        if (b !== btn) {
                            b.classList.remove('active');
                            const otherTarget = document.querySelector(b.getAttribute('data-target'));
                            if (otherTarget) otherTarget.classList.add('is-hidden');
                        }
                    });
                }

                const isHidden = target.classList.contains('is-hidden');
                if (isHidden) {
                    target.classList.remove('is-hidden');
                    btn.classList.add('active');
                } else {
                    target.classList.add('is-hidden');
                    btn.classList.remove('active');
                }
                updateBottomResizerVisibility();
            }
        });
    });

    updateBottomResizerVisibility();
    initExplorerState();
</script>
</body>
</html>
