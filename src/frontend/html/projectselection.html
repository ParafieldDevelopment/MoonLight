<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MoonLight - Project Selection</title>
    <link rel="stylesheet" href="<%= urlFor('frontend/css/startpage.css') %>">
    <link rel="stylesheet" href="<%= urlFor('frontend/css/topbar.css') %>">
    <link rel="stylesheet" href="<%= urlFor('frontend/css/login.css') %>">
    <link rel="stylesheet" href="<%= urlFor('frontend/css/loadingspinner.css') %>">
    <link rel="stylesheet" href="<%= urlFor('frontend/css/ProjectSelection.css') %>">
    <link rel="stylesheet" href="<%= urlFor('frontend/css/macos.css') %>">
    <link rel="stylesheet" href="<%= urlFor('frontend/css/animations.css') %>">
    <style>
        /* Initially hide elements that will be animated */
        .topnav, .sidebar, .projects-main, .customize-main, .plugins-main, .learn-main, footer {
            opacity: 0;
        }
    </style>
</head>
<body>

<!-- Intro Screen -->
<div id="intro-screen">
    <div id="starfield"></div>
    <img id="intro-logo" src="<%= urlFor('frontend/transparent.png') %>" alt="MoonLight Logo" class="bounce-in">
    <div id="intro-sub" class="fade-in-up">Loading Projects...</div>
</div>

<!-- Topbar -->
<nav class="topnav">
    <div class="topbar">
        <img src="app://frontend/iconcircle2.png" class="icon pulse" alt="App Icon">
        <p>Project Selection</p>
    </div>
    <div class="window-controls">
        <button id="min-btn" title="Minimize">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                 stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14"/>
            </svg>
        </button>
        <button id="max-btn" title="Maximize">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                <path d="M4 4h16v16H4z" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <button id="close-btn" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                 stroke="currentColor" width="22" height="22">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>
</nav>

<!-- Main Content -->
<div class="content">
    <div class="sidebar">
        <div class="jetbrains-logo">
            <img src="<%= urlFor('frontend/iconcircle2.png') %>" alt="JetBrains Logo" class="float">
            <h1 class="fade-in-up">MoonLight</h1>
        </div>
        <ul class="sidebar-nav">
            <li><button class="sidebar-btn active fade-in-up" style="animation-delay: 0.1s;" data-target=".projects-main">Projects</button></li>
            <li><button class="sidebar-btn fade-in-up" style="animation-delay: 0.2s;" data-target=".customize-main">Customize</button></li>
            <li><button class="sidebar-btn fade-in-up" style="animation-delay: 0.3s;" data-target=".plugins-main">Plugins</button></li>
            <li><button class="sidebar-btn fade-in-up" style="animation-delay: 0.4s;" data-target=".learn-main">Learn</button></li>
        </ul>
        <div class="sidebar-controls fade-in-up" style="animation-delay: 0.5s;">
            <button id="settings-btn" class="shake">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.332.183-.582.495-.645.87l-.213 1.28c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 0 1-.26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.645-.87l.213-1.281z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                </svg>
            </button>
            <button id="collab-btn" class="shake">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                </svg>
            </button>
        </div>
    </div>

    <div class="projects-main show">
        <div class="project-controls">
            <input type="text" id="project-search" placeholder="Search projects...">
            <div class="project-buttons">
                <button id="new-project-btn" class="pulse">New Project</button>
                <button id="open-project-btn" class="pulse">Open</button>
                <button id="vcs-project-btn" class="pulse">Get from VCS</button>
            </div>
        </div>
        <div class="project-list-container">
            <ul class="project-list">
            </ul>
        </div>
    </div>

    <div class="customize-main">
        <div class="coming-soon">
            <p>Customize - Coming Soon</p>
        </div>
    </div>

    <div class="plugins-main">
        <div class="coming-soon">
            <p>Plugins - Coming Soon</p>
        </div>
    </div>

    <div class="learn-main">
        <div class="coming-soon">
            <p>Learn - Coming Soon</p>
        </div>
    </div>
</div>


<!-- Footer -->
<footer>
    <div class="account">
        <img src="<%= urlFor('frontend/user.svg') %>" alt="User Icon" style="width: 28px; height: 28px;">
        <span>@username &nbsp; | &nbsp; Account: ???</span>
    </div>
    <div class="build-info">
        2026.0.0.0a â€“ Experimental Alpha Build
    </div>
</footer>

<script>
    window.addEventListener("load", () => {
        const intro = document.getElementById("intro-screen");
        const starfield = document.getElementById("starfield");

        // --- Create dynamic stars ---
        for (let i = 0; i < 150; i++) {
            const star = document.createElement("div");
            star.classList.add("star");
            const size = Math.random() * 2 + 1;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.opacity = Math.random() * 0.8 + 0.2;
            starfield.appendChild(star);
        }

        // --- Spawn shooting stars ---
        function spawnShootingStar() {
            const shootingStar = document.createElement("div");
            shootingStar.classList.add("shooting-star");
            shootingStar.style.top = `${Math.random() * 40 + 10}%`;
            shootingStar.style.left = `-${Math.random() * 200}px`;
            shootingStar.style.animation = `shooting ${1 + Math.random() * 1.5}s linear`;
            intro.appendChild(shootingStar);
            shootingStar.addEventListener('animationend', () => shootingStar.remove());
        }

        const shootingInterval = setInterval(spawnShootingStar, 400);

        // --- Spawn particles ---
        function spawnParticle() {
            const particle = document.createElement("div");
            particle.classList.add("particle");
            particle.style.width = particle.style.height = `${Math.random() * 4 + 2}px`;
            particle.style.background = `hsl(${Math.random() * 360}, 80%, 70%)`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.setProperty('--dx', `${(Math.random() - 0.5) * 200}px`);
            particle.style.setProperty('--dy', `${(Math.random() - 0.5) * 200}px`);
            intro.appendChild(particle);
            particle.addEventListener('animationend', () => particle.remove());
        }

        const particleInterval = setInterval(spawnParticle, 200);

        // --- Fade out intro after 3 seconds ---
        setTimeout(() => {
            intro.classList.add("fade-out");
            clearInterval(shootingInterval);
            clearInterval(particleInterval);

            // --- Trigger Main UI Animations ---
            // Add classes to trigger animations after intro fades out
            document.querySelector('.topnav').classList.add('fade-in');
            document.querySelector('.sidebar').classList.add('slide-in-left');
            document.querySelector('.projects-main').classList.add('fade-in-up');
            document.querySelector('.customize-main').classList.add('fade-in-up');
            document.querySelector('.plugins-main').classList.add('fade-in-up');
            document.querySelector('.learn-main').classList.add('fade-in-up');
            document.querySelector('footer').classList.add('fade-in-up');

            // Make sure they are visible now (override opacity: 0)
             document.querySelectorAll('.topnav, .sidebar, .projects-main, .customize-main, .plugins-main, .learn-main, footer').forEach(el => {
                el.style.opacity = '1';
            });

        }, 3000);
    });

    document.addEventListener("DOMContentLoaded", () => {
        console.log("Project Selection DOM Loaded");

        if (!window.moonlight) {
            console.error("Moonlight API not found! Preload script might have failed.");
            return;
        }

        // Helper function to safe-add event listeners
        const addClick = (id, fn) => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('click', fn);
            } else {
                console.warn(`Element with id "${id}" not found.`);
            }
        };

        // Window controls
        addClick('min-btn', () => window.moonlight.minimize());
        addClick('max-btn', () => window.moonlight.maximize());
        addClick('close-btn', () => window.moonlight.close());

        // Project buttons
        addClick('new-project-btn', () => window.moonlight.newProject());
        addClick('open-project-btn', () => window.moonlight.openProject());
        addClick('vcs-project-btn', () => window.moonlight.vcsProject());

        // Settings and Collaboration
        addClick('settings-btn', () => window.moonlight.openSettings());
        addClick('collab-btn', () => window.moonlight.openCollab());

        // Project items
        document.querySelectorAll('.project-item').forEach(item => {
            item.addEventListener('click', () => {
                // window.moonlight.sendOpenProject();
            });
        });

        window.moonlight.updateSelectionPage((data) => {
            if (data.length === 0) {
                const list = document.querySelector('.project-list');
                list.style.height = '100%';
                list.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;" class="fade-in-up">
                        <img src="app://assets/404.png" alt="No projects found" style="width: 128px; height: 128px; opacity: 0.8;" class="float">
                        <p style="margin-top: 10px; color: #888;">No projects found.</p>
                    </div>`;
                return;
            }

            data.forEach((project, index) => {
                const li = document.createElement("li");
                li.className = "project-item fade-in-up";
                li.style.animationDelay = `${index * 0.1}s`;
                li.dataset.id = project.id;

                const img = document.createElement("img");
                img.src = project.icon;
                img.alt = "Project Icon";

                const info = document.createElement("div");
                info.className = "project-info";

                const h3 = document.createElement("h3");
                h3.textContent = project.title;

                const p = document.createElement("p");
                p.textContent = project.description;

                info.append(h3, p);
                li.append(img, info);
                document.querySelector('.project-list').appendChild(li);
            });


        });

        /** @type {NodeListOf<HTMLButtonElement>} */
        const sidebarBtns = document.querySelectorAll('.sidebar-btn');

        /** @type {Element[]} */
        const panels = [
            document.querySelector('.projects-main'),
            document.querySelector('.customize-main'),
            document.querySelector('.plugins-main'),
            document.querySelector('.learn-main')
        ].filter(Boolean);

        const labelToPanelClass = {
            Projects: 'projects-main',
            Customize: 'customize-main',
            Plugins: 'plugins-main',
            Learn: 'learn-main'
        };

        sidebarBtns.forEach((btn) => {
            const label = (btn.textContent || '').trim();
            const panelClass = labelToPanelClass[label];
            if (panelClass) btn.dataset.target = `.${panelClass}`;
        });

        function showPanel(selector) {
            panels.forEach(p => p.classList.remove('show'));
            const panel = document.querySelector(selector);
            if (panel) {
                panel.classList.add('show');
                panel.classList.remove('fade-in-up');
                void panel.offsetWidth; // trigger reflow
                panel.classList.add('fade-in-up');
            }
        }

        sidebarBtns.forEach((btn) => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;

                if (target) showPanel(target);

                sidebarBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Optional: ensure the initial state matches the button that starts as ".active"
        /** @type {HTMLButtonElement | null} */
        const initiallyActive = document.querySelector('.sidebar-btn.active');

        if (initiallyActive && initiallyActive.dataset.target) {
            showPanel(initiallyActive.dataset.target);
        }
    });
</script>
</body>
</html>
